"use server";

import prisma from "@/shared/lib/prisma";
import { VulnerabilityStatus } from "../types";
import { VulnerabilityFormData } from "../schemas/vulnerabilitySchema";
import { calculateRiskForAsset } from "../../risk/services/riskEngine";

export async function getVulnerabilities() {
    return await prisma.vulnerability.findMany({
        orderBy: { severity: 'desc' },
        include: {
            asset: {
                select: {
                    name: true,
                    criticality: true
                }
            }
        }
    });
}

export async function updateVulnerabilityStatus(id: string, status: VulnerabilityStatus) {
    const updated = await prisma.vulnerability.update({
        where: { id },
        data: {
            status,
            mitigatedAt: status === 'MITIGADA' ? new Date() : null
        },
        include: {
            asset: {
                select: {
                    id: true,
                    name: true,
                    criticality: true
                }
            }
        }
    });

    if (updated.assetId) {
        await calculateRiskForAsset(updated.assetId);
    }

    return updated;
}
export async function createVulnerability(data: VulnerabilityFormData) {
    const newVuln = await prisma.vulnerability.create({
        data: {
            ...data,
            severity: Number(data.severity),
        },
        include: {
            asset: {
                select: {
                    id: true,
                    name: true,
                    criticality: true
                }
            }
        }
    });

    if (newVuln.assetId) {
        await calculateRiskForAsset(newVuln.assetId);
    }

    return newVuln;
}
