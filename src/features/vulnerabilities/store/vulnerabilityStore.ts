import { create } from 'zustand';
import { VulnerabilityStore, VulnerabilityStatus } from '../types';
import { getVulnerabilities, updateVulnerabilityStatus, createVulnerability } from '../services/vulnerabilityService';
import { VulnerabilityFormData } from '../schemas/vulnerabilitySchema';

export const useVulnerabilityStore = create<VulnerabilityStore>((set) => ({
    vulnerabilities: [],
    loading: false,
    error: null,
    fetchVulnerabilities: async () => {
        set({ loading: true, error: null });
        try {
            const data = await getVulnerabilities();
            // Transforming data if needed, but Prisma result matches our interface closely
            set({ vulnerabilities: data as any, loading: false });
        } catch (error) {
            set({ error: 'Fallo al obtener vulnerabilidades', loading: false });
        }
    },
    updateStatus: async (id: string, status: VulnerabilityStatus) => {
        try {
            const updated = await updateVulnerabilityStatus(id, status);
            set((state) => ({
                vulnerabilities: state.vulnerabilities.map((v) =>
                    v.id === id ? { ...v, ...updated } : v
                )
            }));
        } catch (error) {
            set({ error: 'Fallo al actualizar estado' });
        }
    },
    addVulnerability: async (formData: VulnerabilityFormData) => {
        set({ loading: true, error: null });
        try {
            const newVuln = await createVulnerability(formData);
            set((state) => ({
                vulnerabilities: [newVuln as any, ...state.vulnerabilities],
                loading: false
            }));
        } catch (error) {
            set({ error: 'Fallo al crear vulnerabilidad', loading: false });
            throw error;
        }
    },
}));
